---
# Unified LAN Discovery Playbook
#
# Works on both:
#   - OPNsense Firewalls (via API + SSH)
#   - Network Probes (Debian x86 via SSH)
#
# Usage:
#   ansible-playbook discovery_lan.yml

- name: LAN Discovery and Sync to NetBox
  hosts: all
  gather_facts: true
  serial: 10
  
  vars:
    netbox_url: "{{ lookup('env', 'NETBOX_URL') }}"
    netbox_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"
    # Proxy for AWX to talk to NB if needed
    proxy_env:
      http_proxy: "{{ lookup('env', 'HTTP_PROXY') | default(omit) }}"
      https_proxy: "{{ lookup('env', 'HTTPS_PROXY') | default(omit) }}"
    
  tasks:
    # =========================================================================
    # Task 1: Identify and Prepare Target
    # =========================================================================
    - name: Set target platform facts
      ansible.builtin.set_fact:
        is_opnsense: "{{ ansible_os_family == 'FreeBSD' }}"
        is_probe: "{{ ansible_os_family == 'Debian' }}"
        # Extract tenant from hostname or variable
        target_tenant: "{{ tenant_slug | default(ansible_hostname.split('-')[0]) }}"
        vrf_name: "{{ (tenant_slug | default(ansible_hostname.split('-')[0]) | upper) }}-VRF"

    - name: Ensure Nmap is installed (OPNsense)
      ansible.builtin.raw: pkg install -y nmap
      when: is_opnsense
      become: true

    - name: Ensure Nmap is installed (Probe)
      ansible.builtin.apt:
        name: nmap
        state: present
        update_cache: yes
      when: is_probe
      become: true

    # =========================================================================
    # Task 2: Calculate Subnets to Scan
    # =========================================================================
    - name: Detect subnets (Probe)
      ansible.builtin.set_fact:
        scan_subnets: >-
          {%- set subnets = [] -%}
          {%- for ip in ansible_all_ipv4_addresses -%}
            {%- set net = ip | ansible.utils.ipaddr('network/24') -%}
            {%- if net and (ip.startswith('10.') or ip.startswith('192.168.') or ip.startswith('172.')) -%}
              {%- set _ = subnets.append(net) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ subnets | unique }}
      when: is_probe

    - name: Fetch interface config for subnets (OPNsense)
      environment: "{{ proxy_env }}"
      ansible.builtin.uri:
        url: "https://{{ ansible_host }}:{{ api_port | default(1337) }}/api/diagnostics/interface/getInterfaceConfig"
        user: "{{ opn_api_key }}"
        password: "{{ opn_api_secret }}"
        force_basic_auth: true
        validate_certs: false
      register: if_config_resp
      when: is_opnsense
      delegate_to: localhost

    - name: Calculate subnets (OPNsense)
      ansible.builtin.set_fact:
        scan_subnets: >-
          {%- set networks = [] -%}
          {%- for iface_name, iface_data in if_config_resp.json.items() -%}
            {%- if iface_data.ipv4 is defined and iface_data.ipv4 | length > 0 -%}
              {%- for ip_info in iface_data.ipv4 -%}
                {%- set ip = ip_info.ipaddr -%}
                {%- set cidr = ip | ansible.utils.ipaddr('network') + '/' + (ip_info.subnetbits | string) -%}
                {%- if ip.startswith('10.') or ip.startswith('192.168.') or ip.startswith('172.') -%}
                  {%- set _ = networks.append(cidr) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ networks | unique }}
      when: is_opnsense

    # =========================================================================
    # Task 3: Run Scan and Parse
    # =========================================================================
    - name: Run Nmap scan on target
      ansible.builtin.shell:
        cmd: "nmap -sn {{ scan_subnets | join(' ') }} -oX /tmp/scan.xml"
      when: scan_subnets | length > 0

    - name: Fetch scan results
      ansible.builtin.fetch:
        src: /tmp/scan.xml
        dest: "/tmp/{{ ansible_hostname }}_scan.xml"
        flat: yes

    - name: Parse results on localhost
      ansible.builtin.shell: |
        python3 << 'EOF'
        import xml.etree.ElementTree as ET
        import json
        tree = ET.parse('/tmp/{{ ansible_hostname }}_scan.xml')
        root = tree.getroot()
        hosts = []
        for host in root.findall('host'):
            status = host.find('status')
            if status is not None and status.get('state') == 'up':
                ip = ''
                mac = ''
                hostname = ''
                for addr in host.findall('address'):
                    if addr.get('addrtype') == 'ipv4': ip = addr.get('addr')
                    if addr.get('addrtype') == 'mac': mac = addr.get('addr')
                hnames = host.find('hostnames')
                if hnames is not None:
                    hn = hnames.find('hostname')
                    if hn is not None: hostname = hn.get('name')
                if ip: hosts.append({'ip': ip, 'mac': mac, 'hostname': hostname})
        print(json.dumps(hosts))
        EOF
      delegate_to: localhost
      register: parsed_output
      changed_when: false

    - name: Set discovered hosts fact
      ansible.builtin.set_fact:
        discovered_hosts: "{{ parsed_output.stdout | from_json }}"

    # =========================================================================
    # Task 4: Sync to NetBox
    # =========================================================================
    - name: Sync discovered devices to NetBox
      netbox.netbox.netbox_device:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        data:
          name: "Discovered-{{ item.mac if item.mac else item.ip }}"
          device_role: "Discovered"
          device_type: "Generic Host"
          status: "active"
          site: "remote-site"
          tenant: "{{ target_tenant }}"
        state: present
      loop: "{{ discovered_hosts }}"
      when: item.mac != ""
      ignore_errors: true

    - name: Sync IP addresses to NetBox (with VRF isolation)
      netbox.netbox.netbox_ip_address:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        data:
          address: "{{ item.ip }}/32"
          status: "active"
          vrf: "{{ vrf_name }}"
          tenant: "{{ target_tenant }}"
          dns_name: "{{ item.hostname if item.hostname else omit }}"
          assigned_object:
            device: "Discovered-{{ item.mac if item.mac else item.ip }}"
            name: "eth0"
        state: present
      loop: "{{ discovered_hosts }}"
      when: item.mac != ""
      ignore_errors: true

    - name: Finalize scan
      ansible.builtin.file:
        path: /tmp/scan.xml
        state: absent
